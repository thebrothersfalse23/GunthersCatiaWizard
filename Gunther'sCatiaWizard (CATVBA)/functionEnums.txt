Enum traversalModes
    tmCollectUniques = 0             ' Function: Returns a collection of unique products found during BFS
    tmCollectAllInstances = 1        ' Function: Returns all product instances (including duplicates) found during BFS
    tmCollectParts = 2               ' Function: Returns only part objects (excluding assemblies)
    tmCollectProducts = 3            ' Function: Returns only product (assembly) objects (excluding parts)
    tmDuplicateProduct = 4           ' Function: Duplicates a product and its structure
    tmAssignProductData = 5          ' Function: Assigns property data to products during traversal
    tmCopyTemplate = 6               ' Function: Copies a product template
    tmCollectLeaves = 7              ' Function: Returns only leaf products (end-nodes)
    tmCollectAssemblies = 8          ' Function: Returns only assemblies (products with children)
    tmCollectByProperty = 9          ' Function: Returns products matching a specific property value
    tmCollectByName = 10             ' Function: Returns products with a specific name
    tmCollectByPartNumber = 11       ' Function: Returns products with a specific part number
    tmCollectByCustomFilter = 12     ' Function: Returns products matching a custom filter function
    tmCountProducts = 13             ' Function: Counts the number of products during traversal
    tmCountParts = 14                ' Function: Counts the number of parts during traversal
    tmLogTraversal = 15              ' Sub: Logs traversal steps for debugging or reporting
    tmValidateStructure = 16         ' Function: Validates product structure for errors or inconsistencies
    tmCollectParents = 17            ' Function: Returns parent products for each node
    tmCollectChildren = 18           ' Function: Returns child products for each node
    tmCollectPaths = 19              ' Function: Returns paths from root to each product/part
    tmSaveAll = 20                   ' Sub: Saves all existing products/parts
    tmSaveAsAll = 21                 ' Sub: Saves all existing products/parts with a new name
    tmSendTo = 22                    ' Sub: copies catia's native 'Send To' functionality 
End Enum

' Wrapper Sub Declarations for Each Traversal Mode
' 0. Collect unique products
Sub collectUniques(Optional ByRef targetProd As Product = Nothing, Optional ByRef uniques As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store unique products if not provided.
    '   - Traverse the product structure using BFS or DFS.
    '   - For each product, check if it is already in the collection (by reference or unique identifier).
    '   - If not present, add it to the collection.
    '   - Continue traversal for all children.
    ' Required Args: targetProd (product)
    ' Optional Args: uniques (collection to store results)
    ' Example: Call collectUniques CATIA.ActiveDocument.Product, myUniques
    If targetProd Is Nothing Then Set targetProd = rootProd
    If uniques Is Nothing Then Set uniques = uniqueProds
End Sub

' 1. Collect all product instances (including duplicates)
Sub collectAllInstances(Optional ByRef targetProd As Product = Nothing, Optional ByRef allInstances As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store all instances if not provided.
    '   - Traverse the product structure recursively.
    '   - Add every encountered product to the collection, including duplicates.
    '   - Continue traversal for all children.
    ' Required Args: targetProd (product)
    ' Optional Args: allInstances (collection to store results)
    ' Example: Call collectAllInstances CATIA.ActiveDocument.Product, myInstances
    If targetProd Is Nothing Then Set targetProd = rootProd
    If allInstances Is Nothing Then Set allInstances = allInstances
End Sub

' 2. Collect only part objects (excluding assemblies)
Sub collectParts(Optional ByRef targetProd As Product = Nothing, Optional ByRef parts As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store parts if not provided.
    '   - Traverse the product structure recursively.
    '   - For each node, check if it is a part (not an assembly).
    '   - If it is a part, add to the collection.
    '   - Continue traversal for all children.
    ' Required Args: targetProd (product)
    ' Optional Args: parts (collection to store results)
    ' Example: Call collectParts CATIA.ActiveDocument.Product, myParts
    If targetProd Is Nothing Then Set targetProd = rootProd
    If parts Is Nothing Then Set parts = uniqueParts
End Sub

' 3. Collect only product (assembly) objects (excluding parts)
Sub collectProducts(Optional ByRef targetProd As Product = Nothing, Optional ByRef products As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store assemblies if not provided.
    '   - Traverse the product structure recursively.
    '   - For each node, check if it is an assembly (not a part).
    '   - If it is an assembly, add to the collection.
    '   - Continue traversal for all children.
    ' Required Args: targetProd (product)
    ' Optional Args: products (collection to store results)
    ' Example: Call collectProducts CATIA.ActiveDocument.Product, myProducts
    If targetProd Is Nothing Then Set targetProd = rootProd
    If products Is Nothing Then Set products = uniqueProds
End Sub

' 4. Duplicate a product and its structure
Sub duplicateProduct(Optional ByRef srcProd As Product = Nothing, Optional ByRef duplicatedProd As Product = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Create a new product object.
    '   - Copy all properties and structure from the source product to the new product.
    '   - Recursively duplicate all children and add them to the new product.
    '   - Return the duplicated product.
    ' Required Args: srcProd (product), duplicatedProd (product to receive the duplicate)
    ' Example: Call duplicateProduct myProduct, myDuplicate
    If srcProd Is Nothing Then Set srcProd = rootProd
    If duplicatedProd Is Nothing Then Set duplicatedProd = Nothing
End Sub

' 5. Assign property data to products during traversal
Sub assignProductData(Optional ByRef targetProd As Product = Nothing, Optional assignType As assignProductDataHelpers = -1, Optional value As Variant = Empty)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Traverse the product structure recursively.
    '   - For each product, assign the specified property using assignType and value.
    '   - Continue traversal for all children if batch assignment is needed.
    ' Required Args: targetProd (product), assignType (assignProductDataHelpers), value (variant)
    ' Example: Call assignProductData CATIA.ActiveDocument.Product, assignPN, "12345"
    ' Usage Examples for assignProductDataHelpers:
    '   assignPN:           Call assignProductData CATIA.ActiveDocument.Product, assignPN, "12345"
    '   assignName:         Call assignProductData CATIA.ActiveDocument.Product, assignName, "Bracket"
    '   assignDescription:  Call assignProductData CATIA.ActiveDocument.Product, assignDescription, "Mounting Bracket"
    '   assignReference:    Call assignProductData CATIA.ActiveDocument.Product, assignReference, "REF-001"
    '   assignSource:       Call assignProductData CATIA.ActiveDocument.Product, assignSource, "SupplierA"
    '   assignNomenclature: Call assignProductData CATIA.ActiveDocument.Product, assignNomenclature, "BRKT-001"
    '   assignRevision:     Call assignProductData CATIA.ActiveDocument.Product, assignRevision, "A"
    '   assignMaterial:     Call assignProductData CATIA.ActiveDocument.Product, assignMaterial, "Steel"
    '   assignColor:        Call assignProductData CATIA.ActiveDocument.Product, assignColor, RGB(255,0,0)
    '   assignQuantity:     Call assignProductData CATIA.ActiveDocument.Product, assignQuantity, 5
    '   assignCustomProperty: Call assignProductData CATIA.ActiveDocument.Product, assignCustomProperty, Array("CustomProp", "Value")
    '   assignMass:         Call assignProductData CATIA.ActiveDocument.Product, assignMass, 2.5
    '   assignVolume:       Call assignProductData CATIA.ActiveDocument.Product, assignVolume, 100
    '   assignDensity:      Call assignProductData CATIA.ActiveDocument.Product, assignDensity, 7.85
    '   assignManufacturer: Call assignProductData CATIA.ActiveDocument.Product, assignManufacturer, "Acme Corp"
    '   assignProject:      Call assignProductData CATIA.ActiveDocument.Product, assignProject, "ProjectX"
    If targetProd Is Nothing Then Set targetProd = rootProd
End Sub

' 6. Similar to assignProductData, this is for batch assignments to bring products into allignment with a template.
Sub tmCopyTemplate(Optional ByRef targetProd As Product = Nothing, Optional ByRef template As Product = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Traverse the target product structure recursively.
    '   - For each node, copy relevant properties from the template product.
    '   - Recursively apply the template to all children.
    ' Required Args: targetProd (product), template (product)
    ' Example: Call tmCopyTemplate CATIA.ActiveDocument.Product, myTemplate.
    If targetProd Is Nothing Then Set targetProd = rootProd
    If template Is Nothing Then Set template = templateProd
End Sub

' 7. Collect only leaf products (end-nodes)
Sub collectLeaves(Optional ByRef targetProd As Product = Nothing, Optional ByRef leaves As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store leaves if not provided.
    '   - Traverse the product structure recursively.
    '   - For each node, check if it has no children.
    '   - If it is a leaf, add to the collection.
    ' Required Args: targetProd (product)
    ' Optional Args: leaves (collection to store results)
    ' Example: Call collectLeaves CATIA.ActiveDocument.Product, myLeaves
    If targetProd Is Nothing Then Set targetProd = rootProd
    If leaves Is Nothing Then Set leaves = Nothing
End Sub

' 8. Collect only assemblies (products with children)
Sub collectAssemblies(Optional ByRef targetProd As Product = Nothing, Optional ByRef assemblies As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store assemblies if not provided.
    '   - Traverse the product structure recursively.
    '   - For each node, check if it has children.
    '   - If it is an assembly, add to the collection.
    ' Required Args: targetProd (product)
    ' Optional Args: assemblies (collection to store results)
    ' Example: Call collectAssemblies CATIA.ActiveDocument.Product, myAssemblies
    If targetProd Is Nothing Then Set targetProd = rootProd
    If assemblies Is Nothing Then Set assemblies = Nothing
End Sub

' 9. Collect products matching a specific property value
Sub collectByProperty(Optional ByRef targetProd As Product = Nothing, Optional propName As String = "", Optional propValue As Variant = Empty, Optional ByRef matches As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store matches if not provided.
    '   - Traverse the product structure recursively.
    '   - For each product, check if the specified property matches the given value.
    '   - If matched, add to the collection.
    ' Required Args: targetProd (product), propName (string), propValue (variant)
    ' Optional Args: matches (collection to store results)
    ' Example: Call collectByProperty CATIA.ActiveDocument.Product, "Material", "Steel", myMatches
    If targetProd Is Nothing Then Set targetProd = rootProd
    If matches Is Nothing Then Set matches = Nothing
End Sub

' 10. Collect products with a specific name
Sub collectByName(Optional ByRef targetProd As Product = Nothing, Optional nameToMatch As String = "", Optional ByRef matches As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store matches if not provided.
    '   - Traverse the product structure recursively.
    '   - For each product, check if its name matches the given name.
    '   - If matched, add to the collection.
    ' Required Args: targetProd (product), nameToMatch (string)
    ' Optional Args: matches (collection to store results)
    ' Example: Call collectByName CATIA.ActiveDocument.Product, "Bracket", myMatches
    If targetProd Is Nothing Then Set targetProd = rootProd
    If matches Is Nothing Then Set matches = Nothing
End Sub

' 11. Collect products with a specific part number
Sub collectByPartNumber(Optional ByRef targetProd As Product = Nothing, Optional partNumber As String = "", Optional ByRef matches As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store matches if not provided.
    '   - Traverse the product structure recursively.
    '   - For each product, check if its part number matches the given value.
    '   - If matched, add to the collection.
    ' Required Args: targetProd (product), partNumber (string)
    ' Optional Args: matches (collection to store results)
    ' Example: Call collectByPartNumber CATIA.ActiveDocument.Product, "PN-001", myMatches
    If targetProd Is Nothing Then Set targetProd = rootProd
    If matches Is Nothing Then Set matches = Nothing
End Sub

' 12. Collect products matching a custom filter function
Sub collectByCustomFilter(Optional ByRef targetProd As Product = Nothing, Optional filterFunc As String = "", Optional ByRef matches As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store matches if not provided.
    '   - Traverse the product structure recursively.
    '   - For each product, call the custom filter function (by name) to determine if it matches.
    '   - If matched, add to the collection.
    ' Required Args: targetProd (product), filterFunc (string: name of filter function)
    ' Optional Args: matches (collection to store results)
    ' Example: Call collectByCustomFilter CATIA.ActiveDocument.Product, "IsCustomPart", myMatches
    If targetProd Is Nothing Then Set targetProd = rootProd
    If matches Is Nothing Then Set matches = Nothing
End Sub

' 13. Count the number of products (assemblies)
Sub countProducts(Optional ByRef targetProd As Product = Nothing, Optional ByRef count As Long = 0)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a counter.
    '   - Traverse the product structure recursively.
    '   - For each node, if it is an assembly, increment the counter.
    '   - Return the final count.
    ' Required Args: targetProd (product), count (long to receive result)
    ' Example: Call countProducts CATIA.ActiveDocument.Product, prodCount
    If targetProd Is Nothing Then Set targetProd = rootProd
End Sub

' 14. Count the number of parts
Sub countParts(Optional ByRef targetProd As Product = Nothing, Optional ByRef count As Long = 0)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a counter.
    '   - Traverse the product structure recursively.
    '   - For each node, if it is a part, increment the counter.
    '   - Return the final count.
    ' Required Args: targetProd (product), count (long to receive result)
    ' Example: Call countParts CATIA.ActiveDocument.Product, partCount
    If targetProd Is Nothing Then Set targetProd = rootProd
End Sub

' 15. Log traversal steps for debugging or reporting
Sub logTraversal(Optional ByRef targetProd As Product = Nothing, Optional logFilePath As String = "")
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Traverse the product structure recursively.
    '   - For each node, log relevant information (e.g., name, type, path).
    '   - Write log entries to a file if a path is provided, or to the console/debug window.
    ' Required Args: targetProd (product)
    ' Optional Args: logFilePath (string: path to log file)
    ' Example: Call logTraversal CATIA.ActiveDocument.Product, "C:\temp\traversal.log"
    If targetProd Is Nothing Then Set targetProd = rootProd
End Sub

' 16. Validate product structure for errors or inconsistencies
Sub validateStructure(Optional ByRef targetProd As Product = Nothing, Optional ByRef isValid As Boolean = True, Optional ByRef errorList As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a flag for validity and a collection for errors if not provided.
    '   - Traverse the product structure recursively.
    '   - For each node, check for structural errors or inconsistencies.
    '   - If errors are found, add to the error list and set validity flag to False.
    '   - Return the validity status and error list.
    ' Required Args: targetProd (product), isValid (boolean to receive result)
    ' Optional Args: errorList (collection to store errors)
    ' Example: Call validateStructure CATIA.ActiveDocument.Product, isValid, myErrors
    If targetProd Is Nothing Then Set targetProd = rootProd
    If errorList Is Nothing Then Set errorList = errorLog
End Sub

' 17. Collect parent products for each node
Sub collectParents(Optional ByRef targetProd As Product = Nothing, Optional ByRef parents As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store parents if not provided.
    '   - Traverse the product structure recursively.
    '   - For each node, record its parent product.
    '   - Add parent-child relationships to the collection.
    ' Required Args: targetProd (product)
    ' Optional Args: parents (collection to store results)
    ' Example: Call collectParents CATIA.ActiveDocument.Product, myParents
    If targetProd Is Nothing Then Set targetProd = rootProd
    If parents Is Nothing Then Set parents = parentProds
End Sub

' 18. Collect child products for each node
Sub collectChildren(Optional ByRef targetProd As Product = Nothing, Optional ByRef children As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store children if not provided.
    '   - Traverse the product structure recursively.
    '   - For each node, collect its immediate children.
    '   - Add child relationships to the collection.
    ' Required Args: targetProd (product)
    ' Optional Args: children (collection to store results)
    ' Example: Call collectChildren CATIA.ActiveDocument.Product, myChildren
    If targetProd Is Nothing Then Set targetProd = rootProd
    If children Is Nothing Then Set children = childProds
End Sub

' 19. Collect paths from root to each product/part
Sub collectPaths(Optional ByRef targetProd As Product = Nothing, Optional ByRef paths As Collection = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Initialize a collection to store paths if not provided.
    '   - Traverse the product structure recursively, maintaining the current path.
    '   - For each node, record the path from root to that node.
    '   - Add each path to the collection.
    ' Required Args: targetProd (product)
    ' Optional Args: paths (collection to store results)
    ' Example: Call collectPaths CATIA.ActiveDocument.Product, myPaths
    If targetProd Is Nothing Then Set targetProd = rootProd
    If paths Is Nothing Then Set paths = Nothing
End Sub

' 20. Save all existing products/parts
Sub saveAll(Optional ByRef targetProd As Product = Nothing)
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Traverse the product structure recursively.
    '   - For each node, call the save method to persist changes.
    ' Required Args: targetProd (product)
    ' Example: Call saveAll CATIA.ActiveDocument.Product
    If targetProd Is Nothing Then Set targetProd = rootProd
End Sub

' 21. Save all existing products/parts with a new name
Sub saveAsAll(Optional ByRef targetProd As Product = Nothing, Optional newName As String = "")
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Traverse the product structure recursively.
    '   - For each node, call the save-as method with the new name.
    ' Required Args: targetProd (product), newName (string)
    ' Example: Call saveAsAll CATIA.ActiveDocument.Product, "NewAssembly"
    If targetProd Is Nothing Then Set targetProd = rootProd
End Sub

' 22. Send all products/parts to a specified destination
Sub sendTo(Optional ByRef targetProd As Product = Nothing, Optional destination As String = "")
    ' Can be run on any product (root or sub-product)
    ' Logic Flow:
    '   - Traverse the product structure recursively.
    '   - For each node, use CATIA's Send To functionality to copy/export to the destination.
    ' Required Args: targetProd (product), destination (string: target location)
    ' Example: Call sendTo CATIA.ActiveDocument.Product, "D:\ExportedAssemblies"
    If targetProd Is Nothing Then Set targetProd = rootProd
End Sub


.' Helpers for assignProductData traversal mode:
' These specify which property to assign to the product during traversal.
Enum assignProductDataHelpers
    assignPN = 0                ' Assigns a Part Number to the product during assignProductData traversal
    assignName = 1              ' Assigns a Name to the product during assignProductData traversal
    assignDescription = 2       ' Assigns a Description to the product during assignProductData traversal
    assignReference = 3         ' Assigns a Reference value to the product during assignProductData traversal
    assignTemplate = 4          ' Assigns product data to all items in the product during assignProductData Traversal by copying each item from a template product.
    assignSource = 5            ' Assigns a Source (origin) to the product during assignProductData traversal
    assignNomenclature = 6      ' Assigns Nomenclature (standardized naming) to the product during assignProductData traversal
    assignRevision = 7          ' Assigns a Revision identifier to the product
    assignMaterial = 8          ' Assigns Material information to the product
    assignColor = 9             ' Assigns Color property to the product
    assignQuantity = 10         ' Assigns Quantity value to the product
    assignCustomProperty = 11   ' Assigns a custom property (user-defined) to the product
    assignMass = 12             ' Assigns Mass property to the product
    assignVolume = 13           ' Assigns Volume property to the product
    assignDensity = 14          ' Assigns Density property to the product
    assignManufacturer = 15     ' Assigns Manufacturer information to the product
    assignProject = 16          ' Assigns Project or job number to the product
End Enum

' Alternative approach: Use a mapping function for property assignment
' This allows for easier extension and avoids hardcoding logic in multiple places.
' Example usage:
'   Call assignProductProperty(prod, assignPN, "12345")
Public Sub assignProductProperty(prod As Product, assignType As assignProductDataHelpers, value As Variant)
    Select Case assignType
        Case assignPN
            prod.PartNumber = value
        Case assignName
            prod.Name = value
        Case assignDescription
            prod.Description = value
        Case assignReference
            prod.ReferenceProduct = value
        Case assignSource
            prod.Source = value
        Case assignNomenclature
            prod.Nomenclature = value
        Case assignRevision
            prod.Revision = value
        Case assignMaterial
            prod.Material = value
        Case assignMass
            prod.Mass = value
        Case assignVolume
            prod.Volume = value
        Case assignDensity
            prod.Density = value
        Case assignManufacturer
            prod.Manufacturer = value
        Case assignProject
            prod.Project = value
    End Select
End Sub



' Module-level variables for global state management
' These variables are declared as Public in a standard module (e.g., Globals.bas)
' to avoid passing them as arguments between functions/subs.

Public rootDoc As Document           ' CATIA.activeDocument
Public rootProd As Product           ' CATIA.activeDocument.Product
Public rootSel As Selection          ' CATIA.activeDocument.Selection
Public currentProd As Product        ' The currently processed product object.
Public selectedProds As Collection   ' Collection of product objects selected by the user or process.
Public templateProd As Product       ' The product object used as a template for creating new products.
Public uniqueProdRefs As Collection  ' Collection of unique product reference identifiers.
Public uniqueProds As Collection     ' Collection of unique product objects (no duplicates).
Public uniquePartRefs As Collection  ' Collection of unique part reference identifiers.
Public uniqueParts As Collection     ' Collection of unique part objects (no duplicates).
Public allProdRefs As Collection     ' Collection of all product reference identifiers in the structure.
Public allProds As Collection        ' Collection of all product objects in the structure.
Public allUniques As Collection      ' Collection of all unique objects (products and/or parts).
Public allInstances As Collection    ' Collection of all product or part instances in the assembly.
Public partDocs As Collection        ' Collection of document objects corresponding to parts.
Public prodDocs As Collection        ' Collection of document objects corresponding to products.
Public allPartNumbers As Collection  ' Collection of all part numbers in the structure.
Public allNames As Collection        ' Collection of all product/part names in the structure.
Public allDescriptions As Collection ' Collection of all descriptions in the structure.
Public errorLog As Collection        ' Collection of error messages or logs for debugging.
Public processedNodes As Collection  ' Collection of already processed nodes/products to avoid cycles.
Public parentProds As Collection     ' Collection of parent product objects for hierarchy tracking.
Public childProds As Collection      ' Collection of child product objects for hierarchy tracking.
Public userInputs As Collection      ' Collection of user input values for session tracking.
Public tempCache As Collection       ' Temporary cache for intermediate results during processing.

public sub generateSingleTD()
    ' Implementation for generating a single Tool Design (TD)
    ' accepts the following arguments:
        'Required: tdProduct as product
        'Required: tdParams as collection
            ' createNewProduct as boolean
            ' templateProduct as product
            ' protectRefs as boolean
            ' addSuffixToSel as boolean
        'Optional: templateProduct as product

End Sub